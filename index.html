<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Parser Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            position: relative;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at top, #1a1a2e 0%, #16213e 25%, #0f0f23 50%, #000000 100%);
        }

        .background-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            animation: aurora 20s ease-in-out infinite;
        }

        .background-animation::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(255,255,255,0.15) 1px, transparent 0);
            background-size: 50px 50px;
            animation: stars 30s linear infinite;
        }

        @keyframes aurora {
            0%, 100% { 
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
            25% { 
                opacity: 0.8;
                transform: rotate(1deg) scale(1.1);
            }
            50% { 
                opacity: 0.9;
                transform: rotate(-1deg) scale(0.9);
            }
            75% { 
                opacity: 0.7;
                transform: rotate(0.5deg) scale(1.05);
            }
        }

        @keyframes stars {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-50px); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #fff, #f0f9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255,255,255,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card {
            background: rgba(15, 15, 35, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(120, 119, 198, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: slideUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(120, 119, 198, 0.6), transparent);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 15px 40px rgba(120, 119, 198, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(120, 119, 198, 0.4);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(45deg, #7877c6, #4facfe);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(120, 119, 198, 0.3);
        }

        /* Database Overview Section */
        .database-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(120, 119, 198, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(120, 119, 198, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            background: rgba(120, 119, 198, 0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.8;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .database-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Upload Section */
        .upload-area {
            border: 2px dashed rgba(120, 119, 198, 0.4);
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: rgba(120, 119, 198, 0.05);
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            border-color: rgba(120, 119, 198, 0.6);
            background: rgba(120, 119, 198, 0.1);
            transform: scale(1.01);
        }

        .upload-area.dragover {
            border-color: #7877c6;
            background: rgba(120, 119, 198, 0.2);
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(120, 119, 198, 0.3);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .upload-area h3 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-bottom: 2rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(120, 119, 198, 0.1);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            animation: fadeIn 0.3s ease;
            border: 1px solid rgba(120, 119, 198, 0.2);
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: rgba(120, 119, 198, 0.15);
            transform: translateX(5px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .file-name {
            font-weight: 500;
            flex: 1;
        }

        .file-size {
            opacity: 0.7;
            font-size: 0.9rem;
            margin-right: 1rem;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #7877c6, #4facfe);
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(120, 119, 198, 0.3);
            text-align: center;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(120, 119, 198, 0.4);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .btn:active {
                transform: translateY(0);
                box-shadow: 0 4px 12px rgba(120, 119, 198, 0.35);
                filter: brightness(0.98);
            }

            .btn:focus-visible {
                outline: 2px solid rgba(120, 119, 198, 0.9);
                outline-offset: 2px;
                box-shadow: 0 0 0 4px rgba(120, 119, 198, 0.25), 0 8px 25px rgba(120, 119, 198, 0.4);
            }

            .btn-secondary {
                background: linear-gradient(45deg, #ff77c6, #f093fb);
            }

            .btn-secondary:hover {
                box-shadow: 0 8px 25px rgba(255, 119, 198, 0.4);
            }

            .btn-danger {
                background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            }

            .btn-danger:hover {
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            }

            .btn-ai {
                background: linear-gradient(45deg, #78dbff, #7877c6);
            }

            .btn-ai:hover {
                box-shadow: 0 8px 25px rgba(120, 219, 255, 0.4);
            }

            .btn-full {
                width: 100%;
                margin-top: 1rem;
            }

            .remove-file {
                background: rgba(239, 68, 68, 0.8);
                border: none;
                border-radius: 8px;
                color: white;
                padding: 0.5rem 1rem;
                cursor: pointer;
                font-size: 0.85rem;
                transition: all 0.3s ease;
            }

            .remove-file:hover {
                background: rgba(239, 68, 68, 1);
                transform: scale(1.05);
            }
        
        .progress-bar {
            background: rgba(120, 119, 198, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 1.5rem 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #7877c6, #4facfe);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* AI Matching Section */
        .requirements-input {
            width: 100%;
            min-height: 140px;
            padding: 1.5rem;
            border: 2px solid rgba(120, 119, 198, 0.3);
            border-radius: 16px;
            background: rgba(15, 15, 35, 0.6);
            color: white;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .requirements-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .requirements-input:focus {
            outline: none;
            border-color: #7877c6;
            background: rgba(15, 15, 35, 0.8);
            box-shadow: 0 0 20px rgba(120, 119, 198, 0.3);
        }

        .match-results {
            margin-top: 2rem;
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }

        .match-item {
            background: rgba(15, 15, 35, 0.6);
            border: 1px solid rgba(120, 119, 198, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease;
        }

        .match-item:hover {
            background: rgba(15, 15, 35, 0.8);
            border-color: rgba(120, 119, 198, 0.5);
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .match-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }

        .match-percentage {
            font-size: 1.8rem;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .match-percentage.high {
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
        }

        .match-percentage.medium {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .match-percentage.low {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .match-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .match-reasoning {
            background: rgba(120, 119, 198, 0.1);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #7877c6;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .match-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .skill-tag {
            background: rgba(120, 119, 198, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid rgba(120, 119, 198, 0.3);
            transition: all 0.3s ease;
        }

        .skill-tag.matched {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        /* CV List */
        .cv-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .cv-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .cv-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .cv-info {
            flex: 1;
        }

        .cv-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .cv-details {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .cv-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 8px;
        }

        /* Status Messages */
        .status {
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            display: none;
            font-weight: 500;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }

        .status.warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: #f59e0b;
        }

        /* Results Section */
        .results {
            margin-top: 2rem;
            display: none;
        }

        .result-item {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            animation: slideIn 0.5s ease;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 4rem;
            opacity: 0.7;
            padding: 3rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 15, 35, 0.5);
            border-radius: 20px 20px 0 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .database-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .database-actions {
                grid-template-columns: 1fr;
            }
            
            .match-details {
                grid-template-columns: 1fr;
            }
            
            .match-percentage {
                font-size: 1.4rem;
                padding: 0.5rem 1rem;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            opacity: 0.7;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(120, 119, 198, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(120, 119, 198, 0.7);
        }
        /* ADDITIONS TO YOUR EXISTING MAIN CSS - Add these to your existing styles */

        /* Updated match-item styles to work with dark theme */
        .match-item {
            background: rgba(15, 15, 35, 0.6);
            border: 1px solid rgba(120, 119, 198, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease;
        }

        .match-item:hover {
            background: rgba(15, 15, 35, 0.8);
            border-color: rgba(120, 119, 198, 0.5);
            transform: translateY(-2px);
        }

        .match-basic-info {
            margin: 15px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .basic-info-item {
            padding: 8px;
            background: rgba(120, 119, 198, 0.1);
            border-radius: 6px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(120, 119, 198, 0.2);
        }

        .match-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .contact-info-btn, .full-profile-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .contact-info-btn {
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
        }

        .contact-info-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .full-profile-btn {
            background: linear-gradient(45deg, #7877c6, #4facfe);
            color: white;
        }

        .full-profile-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(120, 119, 198, 0.3);
        }

        .skill-tag.more {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        /* Update match percentage classes for dark theme */
        .match-percentage.excellent {
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
        }

        .match-percentage.high {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .match-percentage.medium {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        /* Modal styles - Updated for dark theme integration */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease;
            border: 1px solid rgba(120, 119, 198, 0.3);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #7877c6 0%, #4facfe 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 25px;
            color: white;
        }

        .contact-details {
            max-width: 100%;
        }

        .contact-section h3 {
            color: white;
            margin-bottom: 15px;
            border-bottom: 2px solid #7877c6;
            padding-bottom: 8px;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(120, 119, 198, 0.1);
            border-radius: 8px;
            border-left: 4px solid #7877c6;
            border: 1px solid rgba(120, 119, 198, 0.2);
        }

        .contact-label {
            font-weight: 600;
            color: white;
            min-width: 100px;
        }

        .contact-value {
            text-align: right;
            flex-grow: 1;
            margin-left: 10px;
            color: rgba(255, 255, 255, 0.9);
        }

        .contact-value a {
            color: #4facfe;
            text-decoration: none;
        }

        .contact-value a:hover {
            text-decoration: underline;
        }

        .quick-summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }

        .quick-summary h4 {
            color: #4facfe;
            margin-bottom: 10px;
        }

        .quick-summary p {
            margin: 5px 0;
            color: rgba(255, 255, 255, 0.9);
        }

        .profile-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-section:last-child {
            border-bottom: none;
        }

        .profile-section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .profile-item {
            background: rgba(120, 119, 198, 0.1);
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 3px solid #4facfe;
        }

        .summary-content {
            background: rgba(79, 172, 254, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .candidate-description {
            margin-top: 10px;
            padding: 12px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 6px;
            border-left: 3px solid #4facfe;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }

        .experience-item, .education-item, .project-item, .award-item, .volunteer-item {
            background: rgba(120, 119, 198, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #22c55e;
            border: 1px solid rgba(120, 119, 198, 0.2);
        }

        .exp-header, .edu-header, .project-header, .award-header, .volunteer-header {
            color: white;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .exp-duration, .edu-duration, .project-duration, .award-date, .volunteer-duration {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
            margin: 4px 0;
        }

        .exp-description, .edu-gpa, .project-description, .award-description, .volunteer-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-top: 8px;
        }

        .courses-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .courses-section h4 {
            color: #4facfe;
            margin-bottom: 10px;
        }

        /* .experience-item h4, .education-item h4, .project-item h4 {
            color: white;
            margin-bottom: 8px;
        } */

        .company, .institution {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin: 4px 0;
        }

        .duration {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9em;
            margin: 4px 0;
        }

        .description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-top: 8px;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-spinner::before {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(120, 119, 198, 0.3);
            border-top: 3px solid #7877c6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Skills & Competencies Styling */
        .skill-category {
            margin-bottom: 20px;
        }

        .skill-category > strong {
            display: block;
            color: #7877c6;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .skill-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .skill-tag {
            background: linear-gradient(135deg, rgba(120, 119, 198, 0.2), rgba(79, 172, 254, 0.2));
            color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            border: 1px solid rgba(120, 119, 198, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .skill-tag:hover {
            background: linear-gradient(135deg, rgba(120, 119, 198, 0.4), rgba(79, 172, 254, 0.4));
            border-color: rgba(120, 119, 198, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(120, 119, 198, 0.3);
        }

        .no-data {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Profile sections styling improvements */
        .profile-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-section h3 {
            color: #7877c6;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .profile-item {
            background: rgba(120, 119, 198, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #7877c6;
        }

        .profile-item strong {
            color: #4facfe;
            display: block;
            margin-bottom: 4px;
        }

        .summary-content {
            background: rgba(79, 172, 254, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Additional responsive updates for match items */
        @media (max-width: 768px) {
            .match-basic-info {
                grid-template-columns: 1fr;
            }
            
            .match-actions {
                flex-direction: column;
            }
            
            .contact-info-btn, .full-profile-btn {
                width: 100%;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .contact-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .contact-value {
                text-align: left;
                margin-left: 0;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    
    <!-- <div class="connection-status" id="connectionStatus">
        üîÑ Checking connection...
    </div> -->
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>CV Parser Pro</h1>
            <p>Advanced AI-powered CV parsing and analysis tool with persistent database storage and intelligent candidate matching.</p>
        </div>

        <div class="main-grid">
            <!-- Database Overview -->
            <div class="card">
                <h2>
                    <div class="icon">üíæ</div>
                    Database Overview
                </h2>
                
                <div class="database-stats" id="databaseStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCvs">0</div>
                        <div class="stat-label">Total CVs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgExperience">0</div>
                        <div class="stat-label">Avg Experience (years)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="topSpecialty">-</div>
                        <div class="stat-label">Top Specialty</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastUpdated">-</div>
                        <div class="stat-label">Last Updated</div>
                    </div>
                </div>
                
                <div class="database-actions">
                    <button class="btn" id="refreshBtn" onclick="app.loadDatabaseStats()">
                        <span id="refreshButtonText">üîÑ Refresh Database</span>
                    </button>
                    <button class="btn btn-secondary" id="exportAllBtn">
                        <span id="exportAllButtonText">üìä Export All to Excel</span>
                    </button>
                    <button class="btn btn-danger" id="clearAllBtn" onclick="app.clearAllCVs()">
                        <span id="clearAllButtonText">üóëÔ∏è Clear All CVs</span>
                    </button>
                </div>
                
                <div class="status" id="databaseStatus"></div>
            </div>

            <!-- Upload New CVs -->
            <div class="card">
                <h2>
                    <div class="icon">üìÑ</div>
                    Upload New CVs
                </h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìé</div>
                    <h3>Drag & Drop or Click to Upload</h3>
                    <p>Support for PDF, DOCX, and TXT files</p>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.docx,.txt">
                </div>
                
                <div class="file-list" id="fileList"></div>
                
                <button class="btn btn-full" id="parseBtn" disabled>
                    <span id="parseButtonText">Parse CVs with AI</span>
                </button>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="status" id="parseStatus"></div>

                <div class="parsed-data-preview" id="parsedDataPreview" style="display: none;">
                    <h4>üìä Parsed Data Preview:</h4>
                    <pre id="jsonPreview"></pre>
                </div>
            </div>

            <!-- AI Candidate Matching -->
            <div class="card">
                <h2>
                    <div class="icon">ü§ñ</div>
                    AI Candidate Matching
                </h2>
                <p style="margin-bottom: 1.5rem; opacity: 0.8;">Enter your job requirements and get AI-powered candidate matching with suitability percentages.</p>
                
                <textarea 
                    id="requirementsInput" 
                    class="requirements-input" 
                    placeholder="Enter job requirements here... 

Example:
- 5+ years experience in software development
- Strong knowledge of React, Node.js, and Python
- Experience with cloud platforms (AWS, Azure)
- Bachelor's degree in Computer Science
- Good communication skills
- Experience with agile methodologies"
                ></textarea>
                
                <button class="btn btn-ai btn-full" id="matchBtn" onclick="app.findMatches()">
                    <span id="matchButtonText">üéØ Find Matching Candidates</span>
                </button>
                
                <div class="status" id="matchStatus"></div>
                
                <div class="match-results" id="matchResults">
                    <!-- Match results will be displayed here -->
                </div>
            </div>

            <!-- Stored CVs -->
            <div class="card">
                <h2>
                    <div class="icon">üìã</div>
                    Stored CVs
                </h2>
                <p style="margin-bottom: 1.5rem; opacity: 0.8;">All parsed CVs are automatically saved to the database and persist between sessions.</p>
                
                <div class="cv-list" id="cvList">
                    <!-- CV items will be loaded here -->
                </div>
                
                <div class="results" id="results">
                    <h3>üìã Export Summary</h3>
                    <div id="exportResults"></div>
                </div>
                
                <div class="status" id="exportStatus"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2025 CV Parser Pro. Advanced AI-powered resume analysis tool.</p>
            <p>Built with Gemini AI ‚Ä¢ Node.js Backend ‚Ä¢ SQLite Database</p>
        </div>
    </div>
    <script>
        // API Configuration
        const API_BASE_URL = '/api';
        const SERVERLESS_MODE = true; // Vercel: disable DB/file-system features

        class CVParserApp {
            constructor() {
                this.files = [];
                // Prevent double export/downloads
                this.exporting = false;
                this.initializeEventListeners();
                this.checkConnection();
                this.loadDatabaseStats();
            }

            async checkConnection() {
                const statusEl = document.getElementById('connectionStatus');
                if (!statusEl) {
                    // Status banner not rendered; silently skip
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/health`);
                    const data = await response.json();
                    if (data.status === 'OK') {
                        statusEl.textContent = '‚úÖ Connected to Server';
                        statusEl.className = 'connection-status connected';
                        
                        // if (!data.geminiConfigured) {
                        //     this.showStatus('parseStatus', '‚ö†Ô∏è Gemini API not configured on server', 'warning');
                        // }
                    } else {
                        throw new Error('Server not healthy');
                    }
                } catch (error) {
                    statusEl.textContent = '‚ùå Server Disconnected';
                    statusEl.className = 'connection-status disconnected';
                    console.error('Connection check failed:', error);
                }
            }

            async loadDatabaseStats() {
                this.setButtonLoading('refreshBtn', 'refreshButtonText', 'üîÑ Loading...');
                
                // In serverless deploy, backend DB endpoints are not available
                if (window.SERVERLESS_MODE) {
                    this.updateDatabaseStats([]);
                    this.renderCVList([]);
                    this.showStatus('databaseStatus', '‚ÑπÔ∏è Running in serverless mode: database features are disabled.', 'warning');
                    this.setButtonNormal('refreshBtn', 'refreshButtonText', 'üîÑ Refresh Database');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateDatabaseStats(data.data);
                        this.renderCVList(data.data);
                        this.showStatus('databaseStatus', `‚úÖ Loaded ${data.count || data.data.length} CVs from database`, 'success');
                    } else {
                        throw new Error('Failed to load CVs');
                    }
                } catch (error) {
                    console.error('Load database stats error:', error);
                    this.showStatus('databaseStatus', '‚ùå Failed to load database', 'error');
                    this.updateDatabaseStats([]);
                    this.renderCVList([]);
                } finally {
                    this.setButtonNormal('refreshBtn', 'refreshButtonText', 'üîÑ Refresh Database');
                }
            }

            // Safely parse possibly-stringified JSON fields from DB
            safeParseJSON(value, fallback = null) {
                if (value == null) return fallback;
                if (typeof value === 'object') return value;
                if (typeof value === 'string') {
                    try {
                        return JSON.parse(value);
                    } catch (e) {
                        return fallback;
                    }
                }
                return fallback;
            }

            // Compute education years client-side from education array entries
            computeEducationYearsLocal(education) {
                const edu = Array.isArray(education) ? education : [];
                // Convert to month intervals
                const toYM = (txt) => {
                    if (!txt) return null;
                    const s = String(txt).trim().toLowerCase();
                    if (!s) return null;
                    if (/(present|current|now|ongoing)/i.test(s)) {
                        const now = new Date();
                        return { y: now.getFullYear(), m: now.getMonth() + 1 };
                    }
                    let m;
                    // MM/YYYY
                    if ((m = s.match(/^(\d{1,2})[\.\/-](\d{4})$/))) {
                        const mm = Math.max(1, Math.min(12, parseInt(m[1], 10)));
                        const yy = parseInt(m[2], 10);
                        return { y: yy, m: mm };
                    }
                    // YYYY-MM or YYYY/M
                    if ((m = s.match(/^(\d{4})[\/-](\d{1,2})$/))) {
                        const yy = parseInt(m[1], 10);
                        const mm = Math.max(1, Math.min(12, parseInt(m[2], 10)));
                        return { y: yy, m: mm };
                    }
                    // Month YYYY (English short/long)
                    const months = {
                        january:1,february:2,march:3,april:4,may:5,june:6,july:7,august:8,september:9,october:10,november:11,december:12,
                        jan:1,feb:2,mar:3,apr:4,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12
                    };
                    const mmName = Object.keys(months).find(k => s.startsWith(k+" "));
                    if (mmName) {
                        const yMatch = s.match(/(19|20)\d{2}/);
                        if (yMatch) return { y: parseInt(yMatch[0],10), m: months[mmName] };
                    }
                    // Fallback: just year
                    if (/^(19|20)\d{2}$/.test(s)) return { y: parseInt(s,10), m: 1 };
                    return null;
                };
                const monthsBetween = (a, b) => {
                    if (!a || !b) return 0;
                    return Math.max(0, (b.y - a.y) * 12 + (b.m - a.m));
                };
                // Collect intervals
                const intervals = [];
                for (const e of edu) {
                    const start = toYM(e.start_date || e.start || (e.duration ? String(e.duration).split('-')[0] : ''));
                    const rawEnd = e.end_date || e.end || e.graduation_date || (e.duration ? String(e.duration).split('-')[1] : '');
                    const end = /present|current|now|ongoing/i.test(String(rawEnd||'')) ? ( () => { const d=new Date(); return { y:d.getFullYear(), m:d.getMonth()+1 }; })() : toYM(rawEnd);
                    if (start && end) intervals.push({ start, end });
                }
                if (!intervals.length) return 0;
                // Merge overlapping intervals by months timeline
                intervals.sort((a,b)=> (a.start.y-a.end.y)||(a.start.m-a.end.m));
                intervals.sort((a,b)=> a.start.y!==b.start.y ? a.start.y-b.start.y : a.start.m-b.start.m);
                const merged = [];
                for (const it of intervals) {
                    if (!merged.length) { merged.push({...it}); continue; }
                    const last = merged[merged.length-1];
                    // if it starts before or at last.end, merge
                    if ((it.start.y < last.end.y) || (it.start.y === last.end.y && it.start.m <= last.end.m)) {
                        // extend end if needed
                        if ((it.end.y > last.end.y) || (it.end.y === last.end.y && it.end.m > last.end.m)) {
                            last.end = { ...it.end };
                        }
                    } else {
                        merged.push({...it});
                    }
                }
                const totalMonths = merged.reduce((sum, it)=> sum + monthsBetween(it.start, it.end), 0);
                return +(totalMonths/12).toFixed(1);
            }

            async ensureSheetJS() {
                return new Promise((resolve, reject) => {
                    if (window.XLSX) return resolve();
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load SheetJS'));
                    document.head.appendChild(script);
                });
            }

            // Collect project website URLs only (exclude generic URLs)
            collectWebsites(cv) {
                const urls = new Set();
                const pushIfValid = (u) => {
                    if (!u) return;
                    const s = String(u).trim();
                    if (!s) return;
                    const lower = s.toLowerCase();
                    if (lower.includes('linkedin.com') || lower.includes('github.com')) return;
                    // basic url validation
                    const hasProtocol = s.startsWith('http://') || s.startsWith('https://');
                    const looksDomain = /^(https?:\/\/)?[\w.-]+\.[a-z]{2,}(\/.*)?$/i.test(s);
                    if (!hasProtocol && !looksDomain) return;
                    urls.add(hasProtocol ? s : `https://${s}`);
                };

                // Only from projects fields (real personal projects)
                const projects = Array.isArray(cv.projects) ? cv.projects : [];
                for (const p of projects) {
                    pushIfValid(p.website || p.url || p.link || p.demo || p.live || p.repo);
                }

                return Array.from(urls);
            }

            // Fallback: ensure LinkedIn/GitHub are present using extracted links
            fillSocialLinksFromMetadata(cv) {
                if (cv && (!cv.linkedin || !cv.github)) {
                    const links = (cv.metadata && Array.isArray(cv.metadata.extracted_links)) ? cv.metadata.extracted_links : [];
                    for (const u of links) {
                        const lower = String(u).toLowerCase();
                        if (!cv.linkedin && lower.includes('linkedin.com')) cv.linkedin = u;
                        if (!cv.github && lower.includes('github.com')) cv.github = u;
                    }
                }
            }

            // Build a second sheet for education periods with computed years
            buildEducationPeriodsSheetData(cvs) {
                const rows = [];
                const parseDate = (s) => {
                    if (!s) return null;
                    const str = String(s).trim();
                    if (!str) return null;
                    // Accept formats like MM/YYYY, YYYY, Month YYYY
                    const present = /present|current|ongoing/i.test(str);
                    if (present) return new Date();
                    // Try MM/YYYY
                    let m;
                    // MM/YYYY
                    if ((m = str.match(/^(\d{1,2})[\.\/-](\d{4})$/))) {
                        const mm = Math.max(1, Math.min(12, parseInt(m[1], 10)));
                        const yy = parseInt(m[2], 10);
                        return new Date(yy, mm - 1, 1);
                    }
                    // Try YYYY
                    if (/^\d{4}$/.test(str)) {
                        return new Date(parseInt(str, 10), 0, 1);
                    }
                    // Try Month YYYY
                    const months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
                    const low = str.toLowerCase();
                    for (let i = 0; i < months.length; i++) {
                        if (low.includes(months[i])) {
                            const yearMatch = low.match(/(19|20)\d{2}/);
                            if (yearMatch) return new Date(parseInt(yearMatch[0],10), i, 1);
                        }
                    }
                    // Fallback Date constructor
                    const d = new Date(str);
                    return isNaN(d.getTime()) ? null : d;
                };
                const diffYears = (a, b) => {
                    if (!a || !b) return null;
                    const months = (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
                    return Math.max(0, Math.round((months / 12) * 100) / 100);
                };
                
                cvs.forEach(cv => {
                    const education = cv.education || [];
                    education.forEach(edu => {
                        const start = parseDate(edu.start_date || edu.start || (edu.duration ? String(edu.duration).split('-')[0] : ''));
                        const end = parseDate(edu.end_date || edu.graduation_date || edu.end || (edu.duration ? String(edu.duration).split('-')[1] : ''));
                        const years = diffYears(start, end || new Date());
                        rows.push({
                            id: cv.id,
                            name: cv.name || 'N/A',
                            institution: edu.institution || edu.university || 'N/A',
                            degree: edu.degree || edu.qualification || 'N/A',
                            field_of_study: edu.field_of_study || '',
                            start: start ? `${String(start.getMonth()+1).padStart(2,'0')}/${start.getFullYear()}` : '',
                            end: end ? `${String(end.getMonth()+1).padStart(2,'0')}/${end.getFullYear()}` : (/(present|current|ongoing)/i.test(edu.end || '') ? 'Present' : ''),
                            years: years != null ? years : ''
                        });
                    });
                });
                return rows;
            }

            async exportAllToExcel() {
                try {
                    await this.ensureSheetJS();
                    // Fetch all CVs from backend
                    const res = await fetch(`${API_BASE_URL}/cvs`);
                    const data = await res.json();
                    const cvs = data.success ? data.cvs : [];
                    if (!cvs.length) {
                        this.showStatus('parseStatus', 'No CVs to export', 'warning');
                        return;
                    }
                    const wb = XLSX.utils.book_new();
                    // Main sheet
                    const mainRows = this.convertToExcelData(cvs);
                    const mainWS = XLSX.utils.json_to_sheet(mainRows);
                    XLSX.utils.book_append_sheet(wb, mainWS, 'CV Summary');
                    // Education Periods sheet
                    const eduRows = this.buildEducationPeriodsSheetData(cvs);
                    const eduWS = XLSX.utils.json_to_sheet(eduRows);
                    XLSX.utils.book_append_sheet(wb, eduWS, 'Education Periods');
                    // Save
                    XLSX.writeFile(wb, `cv_parser_export_${new Date().toISOString().slice(0,10)}.xlsx`);
                    this.showStatus('parseStatus', '‚úÖ Exported to Excel', 'success');
                } catch (e) {
                    console.error('Excel export error:', e);
                    this.showStatus('parseStatus', `‚ùå Export failed: ${e.message}`, 'error');
                }
            }

            updateDatabaseStats(cvs) {
                const totalCvs = cvs.length;
                const avgExperience = totalCvs > 0 ? 
                    cvs.reduce((sum, cv) => sum + (cv.total_years_experience || 0), 0) / totalCvs : 0;
                
                const specialties = {};
                cvs.forEach(cv => {
                    const specialty = cv.professional_specialty || 'Unknown';
                    specialties[specialty] = (specialties[specialty] || 0) + 1;
                });
                
                const topSpecialty = Object.entries(specialties)
                    .sort(([,a], [,b]) => b - a)[0]?.[0] || '-';
                
                const lastUpdated = totalCvs > 0 ? 
                    new Date(Math.max(...cvs.map(cv => new Date(cv.created_at || 0)))).toLocaleDateString() : '-';

                document.getElementById('totalCvs').textContent = totalCvs;
                document.getElementById('avgExperience').textContent = avgExperience.toFixed(1);
                document.getElementById('topSpecialty').textContent = topSpecialty;
                document.getElementById('lastUpdated').textContent = lastUpdated;
            }

            renderCVList(cvs) {
                const cvList = document.getElementById('cvList');
                
                if (cvs.length === 0) {
                    cvList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <p>No CVs in database yet. Upload some CVs to get started!</p>
                        </div>
                    `;
                    return;
                }

                cvList.innerHTML = cvs.map(raw => {
                    const cv = { ...raw };
                    // Normalize parsed fields that might be stringified in DB
                    cv.education = this.safeParseJSON(cv.education, cv.education) || this.safeParseJSON(cv.education_data, []) || cv.education || [];
                    const secondaryFieldsObj = this.safeParseJSON(cv.secondary_experience_fields, {} ) || {};
                    const secondarySummary = Object.entries(secondaryFieldsObj)
                        .sort((a,b)=> (b[1]||0) - (a[1]||0))
                        .slice(0,2)
                        .map(([k,v]) => `${k}: ${v}y`).join(', ');
                    const educationYears = this.computeEducationYearsLocal(cv.education);
                    const totalExp = cv.total_years_experience || 0;
                    const primaryYears = cv.primary_experience_years || 0;
                    const createdAt = cv.created_at ? new Date(cv.created_at).toLocaleDateString() : '';
                    return `
                    <div class="cv-item">
                        <div class="cv-info">
                            <div class="cv-name">${cv.name || cv.filename || 'Unknown'}</div>
                            <div class="cv-details">
                                ${cv.professional_specialty || 'Unknown'} ‚Ä¢ 
                                ${totalExp}y exp ‚Ä¢ Edu ${educationYears}y ‚Ä¢ Primary ${primaryYears}y${secondarySummary ? ' ‚Ä¢ ' + secondarySummary : ''} ‚Ä¢ ${createdAt}
                            </div>
                            ${cv.email ? `<div class="cv-details">üìß ${cv.email}</div>` : ''}
                        </div>
                        <div class="cv-actions">
                            <button class="btn btn-danger btn-small" onclick="app.deleteCv(${cv.id})">Delete</button>
                        </div>
                    </div>
                `}).join('');
            }

            async deleteCv(cvId) {
                if (!confirm('Are you sure you want to delete this CV?')) return;
                
                if (window.SERVERLESS_MODE) {
                    this.showStatus('databaseStatus', '‚ùå Delete is unavailable in serverless mode.', 'error');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs/${cvId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('databaseStatus', '‚úÖ CV deleted successfully', 'success');
                        this.loadDatabaseStats(); // Refresh the list
                    } else {
                        throw new Error('Failed to delete CV');
                    }
                } catch (error) {
                    console.error('Delete CV error:', error);
                    this.showStatus('databaseStatus', '‚ùå Failed to delete CV', 'error');
                }
            }

            async clearAllCVs() {
                if (!confirm('Are you sure you want to delete ALL CVs? This action cannot be undone!')) return;
                
                this.setButtonLoading('clearAllBtn', 'clearAllButtonText', 'üóëÔ∏è Clearing...');
                
                if (window.SERVERLESS_MODE) {
                    this.showStatus('databaseStatus', '‚ùå Clear All is unavailable in serverless mode.', 'error');
                    this.setButtonNormal('clearAllBtn', 'clearAllButtonText', 'üóëÔ∏è Clear All CVs');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('databaseStatus', `‚úÖ Cleared ${data.deletedCount || 'all'} CVs from database`, 'success');
                        this.loadDatabaseStats(); // Refresh the stats
                    } else {
                        throw new Error('Failed to clear CVs');
                    }
                } catch (error) {
                    console.error('Clear CVs error:', error);
                    this.showStatus('databaseStatus', '‚ùå Failed to clear CVs', 'error');
                } finally {
                    this.setButtonNormal('clearAllBtn', 'clearAllButtonText', 'üóëÔ∏è Clear All CVs');
                }
            }

            async exportAllToExcel() {
                this.setButtonLoading('exportAllBtn', 'exportAllButtonText', 'üìä Exporting...');
                
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs`);
                    const data = await response.json();
                    
                    if (data.success && data.data.length > 0) {
                        const excelData = this.convertToExcelData(data.data);
                        
                        // Create workbook using SheetJS
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.json_to_sheet(excelData);
                        
                        // Auto-size columns
                        const colWidths = [];
                        const headers = Object.keys(excelData[0]);
                        headers.forEach((header, i) => {
                            const maxLength = Math.max(
                                header.length,
                                ...excelData.map(row => String(row[header] || '').length)
                            );
                            colWidths[i] = { wch: Math.min(maxLength + 2, 50) };
                        });
                        ws['!cols'] = colWidths;
                        
                        XLSX.utils.book_append_sheet(wb, ws, "All CVs Database");
                        
                        // Generate file and trigger download
                        const fileName = `all_cvs_database_${new Date().toISOString().split('T')[0]}.xlsx`;
                        XLSX.writeFile(wb, fileName);
                        
                        this.showExportResults(data.data);
                        this.showStatus('databaseStatus', '‚úÖ All CVs exported successfully!', 'success');
                        this.createConfetti();
                        this.playSuccessSound();
                    } else {
                        this.showStatus('databaseStatus', '‚ö†Ô∏è No CVs found in database', 'warning');
                    }
                } catch (error) {
                    console.error('Export all error:', error);
                    this.showStatus('databaseStatus', '‚ùå Failed to export CVs', 'error');
                } finally {
                    this.setButtonNormal('exportAllBtn', 'exportAllButtonText', 'üìä Export All to Excel');
                }
            }

            // AI Matching functionality
            async findMatches() {
                const requirements = document.getElementById('requirementsInput').value.trim();
                
                if (!requirements) {
                    this.showStatus('matchStatus', '‚ö†Ô∏è Please enter job requirements first', 'warning');
                    return;
                }

                if (window.SERVERLESS_MODE) {
                    this.showStatus('matchStatus', '‚ÑπÔ∏è AI matching is disabled in serverless demo mode because the database of CVs is unavailable.', 'warning');
                    return;
                }

                this.setButtonLoading('matchBtn', 'matchButtonText', 'ü§ñ Analyzing candidates...');
                
                try {
                    // First, get all CVs from database
                    const cvsResponse = await fetch(`${API_BASE_URL}/cvs`);
                    const cvsData = await cvsResponse.json();
                    
                    if (!cvsData.success || cvsData.data.length === 0) {
                        this.showStatus('matchStatus', '‚ö†Ô∏è No CVs found in database. Please upload some CVs first.', 'warning');
                        return;
                    }

                    // Call AI matching endpoint (AI-only; returns all analyzed matches)
                    const matchResponse = await fetch(`${API_BASE_URL}/match-candidates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requirements: requirements,
                            cvs: cvsData.data
                        })
                    });

                    const matchData = await matchResponse.json();
                    
                    if (matchData.success) {
                        this.displayMatchResults(matchData.matches);

                        const total = matchData.totalAnalyzed ?? (Array.isArray(matchData.matches) ? matchData.matches.length : 0);
                        const statusMessage = total > 0
                            ? `‚úÖ Analyzed ${total} candidates`
                            : `‚ö†Ô∏è No candidates found to analyze.`;

                        this.showStatus('matchStatus', statusMessage, total > 0 ? 'success' : 'warning');
                    } else {
                        throw new Error(matchData.error || 'Matching failed');
                    }

                } catch (error) {
                    console.error('Matching error:', error);
                    this.showStatus('matchStatus', `‚ùå AI Matching failed: ${error.message}. Please try again.`, 'error');
                    // No fallback to basic matching to avoid misleading 100% results
                } finally {
                    this.setButtonNormal('matchBtn', 'matchButtonText', 'üéØ Find Matching Candidates');
                }
            }

            async performSimpleMatching(requirements) {
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs`);
                    const data = await response.json();
                    
                    if (data.success && data.data.length > 0) {
                        const allMatches = this.calculateSimpleMatches(requirements, data.data);
                        // Show all matches; compute qualified count for info
                        this.displayMatchResults(allMatches);

                        const statusMessage = allMatches.length > 0
                            ? `‚ö†Ô∏è Fallback analyzed ${allMatches.length} candidates (basic matching)`
                            : `‚ö†Ô∏è No candidates found to analyze with basic matching.`;

                        this.showStatus('matchStatus', statusMessage, 'warning');
                    }
                } catch (error) {
                    console.error('Simple matching error:', error);
                    this.showStatus('matchStatus', '‚ùå Fallback matching failed', 'error');
                }
            }

            // Add this method to generate contact-only HTML
            generateContactHTML(candidate) {
                return `
                    <div class="contact-details">
                        <div class="contact-section">
                            <h3>üìû Contact Information</h3>
                            <div class="contact-grid">
                                <div class="contact-item">
                                    <span class="contact-label">üìß Email:</span>
                                    <span class="contact-value">
                                        ${candidate.email ? `<a href="mailto:${candidate.email}">${candidate.email}</a>` : 'Not provided'}
                                    </span>
                                </div>
                                <div class="contact-item">
                                    <span class="contact-label">üì± Phone:</span>
                                    <span class="contact-value">
                                        ${candidate.phone ? `<a href="tel:${candidate.phone}">${candidate.phone}</a>` : 'Not provided'}
                                    </span>
                                </div>
                                <div class="contact-item">
                                    <span class="contact-label">üìç Location:</span>
                                    <span class="contact-value">${candidate.address || 'Not provided'}</span>
                                </div>
                                <div class="contact-item">
                                    <span class="contact-label">üíº LinkedIn:</span>
                                    <span class="contact-value">
                                        ${candidate.linkedin ? `<a href="${candidate.linkedin}" target="_blank">View Profile</a>` : 'Not provided'}
                                    </span>
                                </div>
                                <div class="contact-item">
                                    <span class="contact-label">üê± GitHub:</span>
                                    <span class="contact-value">
                                        ${candidate.github ? `<a href="${candidate.github}" target="_blank">View Profile</a>` : 'Not provided'}
                                    </span>
                                </div>
                                <div class="contact-item">
                                    <span class="contact-label">üåê Website:</span>
                                    <span class="contact-value">
                                        ${candidate.website ? `<a href="${candidate.website}" target="_blank">Visit Website</a>` : 'Not provided'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="quick-summary">
                            <h4>Quick Summary</h4>
                            <p><strong>Specialty:</strong> ${candidate.professional_specialty || 'Not specified'}</p>
                            <p><strong>Experience:</strong> ${candidate.total_years_experience || 0} years total</p>
                            <p><strong>Education:</strong> ${candidate.highest_university_degree || 'Not specified'} 
                            ${candidate.university_name ? `from ${candidate.university_name}` : ''}</p>
                        </div>
                    </div>
                `;
            }

            // Add this method to generate full profile HTML
            generateFullProfileHTML(candidate) {
                return `
                    <div class="full-profile">
                        ${this.generateContactHTML(candidate)}
                        
                        <div class="profile-section">
                            <h3>üíº Professional Summary</h3>
                            <p>${candidate.summary || 'No summary available'}</p>
                        </div>

                        <div class="profile-section">
                            <h3>üíª Experience</h3>
                            ${candidate.experience && candidate.experience.length > 0 ? 
                                candidate.experience.map(exp => `
                                    <div class="experience-item">
                                        <h4>${exp.position || 'Position not specified'}</h4>
                                        <p class="company">${exp.company || 'Company not specified'}</p>
                                        <p class="duration">${exp.start_date || ''} - ${exp.end_date || ''}</p>
                                        <p class="description">${exp.description || ''}</p>
                                    </div>
                                `).join('') 
                                : '<p>No experience information available</p>'
                            }
                        </div>

                        <div class="profile-section">
                            <h3>üéì Education</h3>
                            ${candidate.education && candidate.education.length > 0 ? 
                                candidate.education.map(edu => `
                                    <div class="education-item">
                                        <h4>${edu.degree || 'Degree not specified'}</h4>
                                        <p class="institution">${edu.institution || 'Institution not specified'}</p>
                                        <p class="duration">${edu.duration || ''}</p>
                                        ${edu.gpa ? `<p class="gpa">GPA: ${edu.gpa}</p>` : ''}
                                    </div>
                                `).join('') 
                                : '<p>No education information available</p>'
                            }
                        </div>

                        <div class="profile-section">
                            <h3>üõ†Ô∏è Skills</h3>
                            ${candidate.skills ? this.generateSkillsHTML(candidate.skills) : '<p>No skills information available</p>'}
                        </div>

                        ${candidate.projects && candidate.projects.length > 0 ? `
                            <div class="profile-section">
                                <h3>üöÄ Projects</h3>
                                ${candidate.projects.map(project => `
                                    <div class="project-item">
                                        <h4>${project.name || 'Project name not specified'}</h4>
                                        <p>${project.description || ''}</p>
                                        ${project.technologies ? `<p><strong>Technologies:</strong> ${project.technologies.join(', ')}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Helper method to generate skills HTML
            generateSkillsHTML(skills) {
                let skillsHTML = '';
                
                if (skills.technical_skills && skills.technical_skills.length > 0) {
                    skillsHTML += `<p><strong>Technical:</strong> ${skills.technical_skills.join(', ')}</p>`;
                }
                if (skills.programming_languages && skills.programming_languages.length > 0) {
                    skillsHTML += `<p><strong>Programming:</strong> ${skills.programming_languages.join(', ')}</p>`;
                }
                if (skills.frameworks_tools && skills.frameworks_tools.length > 0) {
                    skillsHTML += `<p><strong>Frameworks/Tools:</strong> ${skills.frameworks_tools.join(', ')}</p>`;
                }
                if (skills.soft_skills && skills.soft_skills.length > 0) {
                    skillsHTML += `<p><strong>Soft Skills:</strong> ${skills.soft_skills.join(', ')}</p>`;
                }
                if (skills.languages && skills.languages.length > 0) {
                    skillsHTML += `<p><strong>Languages:</strong> ${skills.languages.join(', ')}</p>`;
                }
                
                return skillsHTML || '<p>No specific skills listed</p>';
            }

            // Add modal functionality if you don't have it
            showModal(title, content) {
                // Create modal if it doesn't exist
                let modal = document.getElementById('candidateModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'candidateModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 id="modalTitle"></h2>
                                <span class="modal-close" onclick="app.closeModal()">&times;</span>
                            </div>
                            <div class="modal-body" id="modalBody"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = content;
                modal.style.display = 'block';
            }

            closeModal() {
                const modal = document.getElementById('candidateModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            async showContactDetails(candidateId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs/${candidateId}`);
                    const data = await response.json();
                    
                    if (data.success && data.cv) {
                        const cv = data.cv;
                        const contactInfo = `
                            <div class="contact-details">
                                <h3>üìû Contact Information</h3>
                                <div class="contact-item">
                                    <strong>Name:</strong> ${cv.name || 'Not provided'}
                                </div>
                                <div class="contact-item">
                                    <strong>Email:</strong> ${cv.email || 'Not provided'}
                                </div>
                                <div class="contact-item">
                                    <strong>Phone:</strong> ${cv.phone || 'Not provided'}
                                </div>
                                <div class="contact-item">
                                    <strong>Address:</strong> ${cv.address || 'Not provided'}
                                </div>
                                <div class="contact-item">
                                    <strong>LinkedIn:</strong> ${cv.linkedin ? `<a href="${cv.linkedin}" target="_blank">${cv.linkedin}</a>` : 'Not provided'}
                                </div>
                                <div class="contact-item">
                                    <strong>GitHub:</strong> ${cv.github ? `<a href="${cv.github}" target="_blank">${cv.github}</a>` : 'Not provided'}
                                </div>
                                <div class="contact-item">
                                    <strong>Website:</strong> ${cv.website ? `<a href="${cv.website}" target="_blank">${cv.website}</a>` : 'Not provided'}
                                </div>
                            </div>
                        `;
                        
                        this.showModal('Contact Information', contactInfo);
                    } else {
                        throw new Error('Failed to fetch candidate details');
                    }
                } catch (error) {
                    console.error('Error fetching contact details:', error);
                    this.showModal('Error', '<p>Failed to load contact information. Please try again.</p>');
                }
            }

            async showFullProfile(candidateId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/cvs/${candidateId}`);
                    const data = await response.json();
                    
                    if (data.success && data.cv) {
                        const cv = data.cv;
                        
                        // Prefer parsed fields from API; fallback to parsing *_data only if needed
                        const safeParse = (json, fallback) => {
                            try { return json ? JSON.parse(json) : fallback; } catch { return fallback; }
                        };
                        
                        const skills = cv.skills && Object.keys(cv.skills).length ? cv.skills : safeParse(cv.skills_data, {});
                        const experience = Array.isArray(cv.experience) && cv.experience.length ? cv.experience : safeParse(cv.experience_data, []);
                        const education = Array.isArray(cv.education) && cv.education.length ? cv.education : safeParse(cv.education_data, []);
                        const projects = Array.isArray(cv.projects) && cv.projects.length ? cv.projects : safeParse(cv.projects_data, []);
                        const awards = Array.isArray(cv.awards) && cv.awards.length ? cv.awards : safeParse(cv.awards_data, []);
                        const volunteerWork = Array.isArray(cv.volunteer_work) && cv.volunteer_work.length ? cv.volunteer_work : safeParse(cv.volunteer_work_data, []);
                        const metadata = cv.metadata && Object.keys(cv.metadata).length ? cv.metadata : safeParse(cv.metadata_data, {});
                        
                        const fullProfile = `
                            <div class="full-profile">
                                <div class="profile-section">
                                    <h3>üë§ Personal Information</h3>
                                    <div class="profile-grid">
                                        <div class="profile-item"><strong>Full Name:</strong> ${cv.name || 'Not provided'}</div>
                                        <div class="profile-item"><strong>Email:</strong> ${cv.email || 'Not provided'}</div>
                                        <div class="profile-item"><strong>Phone:</strong> ${cv.phone || 'Not provided'}</div>
                                        <div class="profile-item"><strong>Address:</strong> ${cv.address || 'Not provided'}</div>
                                        <div class="profile-item"><strong>LinkedIn:</strong> ${cv.linkedin ? `<a href="${cv.linkedin}" target="_blank">${cv.linkedin}</a>` : 'Not provided'}</div>
                                        <div class="profile-item"><strong>GitHub:</strong> ${cv.github ? `<a href="${cv.github}" target="_blank">${cv.github}</a>` : 'Not provided'}</div>
                                    </div>
                                </div>

                                ${cv.summary ? `
                                    <div class="profile-section">
                                        <h3>üìù Professional Summary</h3>
                                        <div class="summary-content">${cv.summary}</div>
                                    </div>
                                ` : ''}
                                
                                
                                
                                <div class="profile-section">
                                    <h3>üéØ Skills & Competencies</h3>
                                    ${this.formatFullSkills(skills)}
                                </div>
                                
                                <div class="profile-section">
                                    <h3>üíº Work Experience</h3>
                                    ${this.formatFullExperience(experience)}
                                </div>
                                
                                <div class="profile-section">
                                    <h3>üéì Education & Qualifications</h3>
                                    ${this.formatFullEducation(education, cv)}
                                    ${cv.courses_completed ? `
                                        <div class="courses-section">
                                            <h4>üìö Additional Courses</h4>
                                            <p>${cv.courses_completed}</p>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${projects && projects.length > 0 ? `
                                    <div class="profile-section">
                                        <h3>üöÄ Projects</h3>
                                        ${this.formatProjects(projects)}
                                    </div>
                                ` : ''}
                                
                                ${awards && awards.length > 0 ? `
                                    <div class="profile-section">
                                        <h3>üèÜ Awards & Achievements</h3>
                                        ${this.formatAwards(awards)}
                                    </div>
                                ` : ''}
                                
                                ${volunteerWork && volunteerWork.length > 0 ? `
                                    <div class="profile-section">
                                        <h3>ü§ù Volunteer Work</h3>
                                        ${this.formatVolunteerWork(volunteerWork)}
                                    </div>
                                ` : ''}
                                
                                <div class="profile-section">
                                    <h3>üìä Profile Metadata</h3>
                                    <div class="profile-grid">
                                        <div class="profile-item"><strong>Added to Database:</strong> ${new Date(cv.created_at).toLocaleDateString()}</div>
                                        <div class="profile-item"><strong>Last Updated:</strong> ${new Date(cv.updated_at).toLocaleDateString()}</div>
                                        <div class="profile-item"><strong>Source File:</strong> ${cv.filename || 'Unknown'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        this.showModal('Full Profile', fullProfile);
                    } else {
                        throw new Error('Failed to fetch candidate details');
                    }
                } catch (error) {
                    console.error('Error fetching full profile:', error);
                    this.showModal('Error', '<p>Failed to load full profile. Please try again.</p>');
                }
            }

            formatFullSkills(skills) {
                if (!skills || Object.keys(skills).length === 0) {
                    return '<p>Not given</p>';
                }
                
                // Helper to deduplicate and normalize
                const uniq = arr => Array.from(new Set((arr || []).map(s => String(s).trim()).filter(Boolean)));
                
                const programming = uniq(skills.programming_languages);
                const frameworks = uniq(skills.frameworks_tools);
                const soft = uniq(skills.soft_skills);
                const langs = uniq(skills.languages);
                const certs = uniq(skills.certifications);
                const technical = uniq(skills.technical_skills);
                
                let skillsHTML = '';
                
                // Technical Skills (broad set)
                skillsHTML += `
                    <div class="skill-category">
                        <strong>Technical Skills:</strong>
                        <div class="skill-list">
                            ${technical.length > 0 
                                ? technical.map(skill => `<span class="skill-tag">${skill}</span>`).join('')
                                : '<span class="no-data">Not given</span>'}
                        </div>
                    </div>
                `;
                
                // Programming Languages
                skillsHTML += `
                    <div class="skill-category">
                        <strong>Programming Languages:</strong>
                        <div class="skill-list">
                            ${programming.length > 0 
                                ? programming.map(skill => `<span class="skill-tag">${skill}</span>`).join('')
                                : '<span class="no-data">Not given</span>'}
                        </div>
                    </div>
                `;
                
                // Frameworks & Tools
                skillsHTML += `
                    <div class="skill-category">
                        <strong>Frameworks & Tools:</strong>
                        <div class="skill-list">
                            ${frameworks.length > 0 
                                ? frameworks.map(skill => `<span class="skill-tag">${skill}</span>`).join('')
                                : '<span class="no-data">Not given</span>'}
                        </div>
                    </div>
                `;
                
                // Soft Skills
                skillsHTML += `
                    <div class="skill-category">
                        <strong>Soft Skills:</strong>
                        <div class="skill-list">
                            ${soft.length > 0 
                                ? soft.map(skill => `<span class="skill-tag">${skill}</span>`).join('')
                                : '<span class="no-data">Not given</span>'}
                        </div>
                    </div>
                `;
                
                // Languages
                skillsHTML += `
                    <div class="skill-category">
                        <strong>Languages:</strong>
                        <div class="skill-list">
                            ${langs.length > 0 
                                ? langs.map(skill => `<span class="skill-tag">${skill}</span>`).join('')
                                : '<span class="no-data">Not given</span>'}
                        </div>
                    </div>
                `;
                
                // Certifications
                skillsHTML += `
                    <div class="skill-category">
                        <strong>Certifications:</strong>
                        <div class="skill-list">
                            ${certs.length > 0 
                                ? certs.map(skill => `<span class="skill-tag">${skill}</span>`).join('')
                                : '<span class="no-data">Not given</span>'}
                        </div>
                    </div>
                `;
                
                return skillsHTML;
            }

            formatProjects(projects) {
                if (!projects || projects.length === 0) {
                    return '<p>Not given</p>';
                }
                
                return projects.map(project => `
                    <div class="project-item">
                        <div class="project-header">
                            <strong>${project.name || project.title || 'Not given'}</strong>
                        </div>
                        <div class="project-description">
                            <strong>Description:</strong> ${project.description || 'Not given'}
                        </div>
                        <div class="project-tech">
                            <strong>Technologies:</strong> ${project.technologies && project.technologies.length > 0 ? project.technologies.join(', ') : 'Not given'}
                        </div>
                        <div class="project-url">
                            <strong>URL:</strong> ${project.url ? `<a href="${project.url}" target="_blank">${project.url}</a>` : 'Not given'}
                        </div>
                        <div class="project-duration">
                            <strong>Duration:</strong> ${project.duration || 'Not given'}
                        </div>
                    </div>
                `).join('');
            }

            formatAwards(awards) {
                if (!awards || awards.length === 0) {
                    return '<p>Not given</p>';
                }
                
                return awards.map(award => `
                    <div class="award-item">
                        <div class="award-header">
                            <strong>${award.title || award.name || 'Not given'}</strong>
                        </div>
                        <div class="award-org">
                            <strong>Awarded by:</strong> ${award.organization || 'Not given'}
                        </div>
                        <div class="award-date">
                            <strong>Date:</strong> ${award.date || 'Not given'}
                        </div>
                        <div class="award-description">
                            <strong>Description:</strong> ${award.description || 'Not given'}
                        </div>
                    </div>
                `).join('');
            }

            formatVolunteerWork(volunteerWork) {
                if (!volunteerWork || volunteerWork.length === 0) {
                    return '<p>Not given</p>';
                }
                
                return volunteerWork.map(work => `
                    <div class="volunteer-item">
                        <div class="volunteer-header">
                            <strong>${work.role || work.position || 'Not given'}</strong>
                            ${work.organization ? ` at ${work.organization}` : ' at Not given'}
                        </div>
                        <div class="volunteer-duration">
                            <strong>Duration:</strong> ${work.duration || 'Not given'}
                        </div>
                        <div class="volunteer-description">
                            <strong>Description:</strong> ${work.description || 'Not given'}
                        </div>
                    </div>
                `).join('');
            }

            formatFullExperience(experience) {
                if (!experience || experience.length === 0) {
                    return '<p>Not given</p>';
                }
                
                return experience.map(exp => `
                    <div class="experience-item">
                        <div class="exp-header">
                            <strong>${exp.position || exp.title || 'Not given'}</strong>
                            ${exp.company ? ` at ${exp.company}` : ' at Not given'}
                        </div>
                        <div class="exp-duration">
                            <strong>Duration:</strong> ${exp.start_date || 'Not given'} - ${exp.end_date || 'Not given'}
                            ${exp.duration ? ` (${exp.duration})` : ''}
                        </div>
                        <div class="exp-location">
                            <strong>Location:</strong> ${exp.location || 'Not given'}
                        </div>
                        ${exp.description ? `
                            <div class="exp-description">
                                <strong>Description:</strong> ${exp.description}
                            </div>
                        ` : '<div class="exp-description"><strong>Description:</strong> Not given</div>'}
                        ${exp.responsibilities && exp.responsibilities.length > 0 ? `
                            <div class="exp-responsibilities">
                                <strong>Key Responsibilities:</strong>
                                <ul>
                                    ${exp.responsibilities.map(resp => `<li>${resp}</li>`).join('')}
                                </ul>
                            </div>
                        ` : '<div class="exp-responsibilities"><strong>Key Responsibilities:</strong> Not given</div>'}
                        ${exp.achievements && exp.achievements.length > 0 ? `
                            <div class="exp-achievements">
                                <strong>Achievements:</strong>
                                <ul>
                                    ${exp.achievements.map(ach => `<li>${ach}</li>`).join('')}
                                </ul>
                            </div>
                        ` : '<div class="exp-achievements"><strong>Achievements:</strong> Not given</div>'}
                    </div>
                `).join('');
            }

            formatFullEducation(education, cv = {}) {
                const hasEdu = Array.isArray(education) && education.length > 0;
                if (!hasEdu) {
                    // Fallback: use top-level CV fields if structured education is missing
                    const degree = cv.highest_university_degree || 'Not given';
                    const uni = cv.university_name || 'Not given';
                    return `
                        <div class="education-item">
                            <div class="edu-header">
                                <strong>${degree}</strong>
                            </div>
                            <div class="edu-institution">
                                <strong>Institution:</strong> ${uni}
                            </div>
                        </div>
                    `;
                }
                
                return education.map(edu => `
                    <div class="education-item">
                        <div class="edu-header">
                            <strong>${edu.degree || edu.qualification || 'Not given'}</strong>
                            ${edu.field_of_study ? ` in ${edu.field_of_study}` : ''}
                        </div>
                        <div class="edu-institution">
                            <strong>Institution:</strong> ${edu.institution || edu.university || 'Not given'}
                        </div>
                        <div class="edu-duration">
                            <strong>Duration:</strong> ${(edu.start_date || edu.start || '').trim() || 'Not given'} - ${(edu.end_date || edu.graduation_date || edu.end || '').trim() || 'Not given'}
                        </div>
                        ${edu.location ? `<div class="edu-location"><strong>Location:</strong> ${edu.location}</div>` : ''}
                        ${edu.gpa ? `<div class="edu-gpa"><strong>GPA:</strong> ${edu.gpa}</div>` : ''}
                        ${edu.honors && edu.honors.length > 0 ? `<div class="edu-honors"><strong>Honors:</strong> ${edu.honors.join(', ')}</div>` : ''}
                        ${edu.relevant_courses && edu.relevant_courses.length > 0 ? `<div class="edu-courses"><strong>Relevant Courses:</strong> ${edu.relevant_courses.join(', ')}</div>` : ''}
                    </div>
                `).join('');
            }

            async findMatches() {
                const requirements = document.getElementById('requirementsInput').value.trim();
                
                if (!requirements) {
                    this.showStatus('matchStatus', '‚ö†Ô∏è Please enter job requirements first', 'warning');
                    return;
                }
                if (window.SERVERLESS_MODE) {
                    this.showStatus('matchStatus', '‚ÑπÔ∏è AI matching is disabled in serverless demo mode because the database of CVs is unavailable.', 'warning');
                    return;
                }

                this.setButtonLoading('matchBtn', 'matchButtonText', 'ü§ñ Analyzing candidates...');
                
                try {
                    // First, get all CVs from database
                    const cvsResponse = await fetch(`${API_BASE_URL}/cvs`);
                    const cvsData = await cvsResponse.json();
                    
                    if (!cvsData.success || cvsData.data.length === 0) {
                        this.showStatus('matchStatus', '‚ö†Ô∏è No CVs found in database. Please upload some CVs first.', 'warning');
                        return;
                    }

                    // Call AI matching endpoint (AI-only; returns all analyzed matches)
                    const matchResponse = await fetch(`${API_BASE_URL}/match-candidates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            requirements: requirements,
                            cvs: cvsData.data
                        })
                    });

                    const matchData = await matchResponse.json();
                    
                    if (matchData.success) {
                        this.displayMatchResults(matchData.matches);

                        const total = matchData.totalAnalyzed ?? (Array.isArray(matchData.matches) ? matchData.matches.length : 0);
                        const statusMessage = total > 0
                            ? `‚úÖ Analyzed ${total} candidates`
                            : `‚ö†Ô∏è No candidates found to analyze.`;

                        this.showStatus('matchStatus', statusMessage, total > 0 ? 'success' : 'warning');
                    } else {
                        throw new Error(matchData.error || 'Matching failed');
                    }

                } catch (error) {
                    console.error('Matching error:', error);
                    this.showStatus('matchStatus', `‚ùå AI Matching failed: ${error.message}. Please try again.`, 'error');
                } finally {
                    this.setButtonNormal('matchBtn', 'matchButtonText', 'üéØ Find Matching Candidates');
                }
            }

            calculateSimpleMatches(requirements, cvs) {
                // Tokenize and normalize requirements
                const rawTokens = requirements.toLowerCase().split(/\W+/).filter(Boolean);
                const stopwords = new Set(['developer','engineer','experience','years','year','with','and','of','in','for','the','a','an','jr','sr','senior','junior','mid','plus']);
                const tokens = [];
                for (let i = 0; i < rawTokens.length; i++) {
                    const t = rawTokens[i];
                    // Combine "full stack" into one semantic token
                    if (t === 'full' && rawTokens[i+1] === 'stack') {
                        tokens.push('fullstack');
                        i++;
                        continue;
                    }
                    if (t.length <= 2) continue;
                    if (stopwords.has(t)) continue;
                    // ignore pure numbers
                    if (/^\d+$/.test(t)) continue;
                    tokens.push(t);
                }
                const reqWords = Array.from(new Set(tokens));
                
                return cvs.map(cv => {
                    const cvText = JSON.stringify(cv).toLowerCase();
                    // word-boundary match to avoid substring inflation
                    const matchedWords = reqWords.filter(word => {
                        const pattern = new RegExp(`(^|[^a-z0-9_])${word}([^a-z0-9_]|$)`, 'i');
                        return pattern.test(cvText);
                    });
                    let percentage = reqWords.length > 0 ? Math.round((matchedWords.length / reqWords.length) * 100) : 0;
                    // Prevent inflated 100% for tiny requirement sets and cap basic to 95
                    if (reqWords.length < 3) {
                        percentage = Math.min(percentage, 85);
                    }
                    percentage = Math.min(percentage, 95);
                    
                    return {
                        cv,
                        percentage,
                        reasoning: `Simple keyword matching found ${matchedWords.length}/${reqWords.length} relevant terms.`,
                        matchedSkills: matchedWords
                    };
                }).sort((a, b) => b.percentage - a.percentage);
            }

            displayMatchResults(matches) {
                const matchResults = document.getElementById('matchResults');
                
                // Show all AI matches as returned by the server
                const allMatches = Array.isArray(matches) ? matches : [];

                if (!allMatches || allMatches.length === 0) {
                    matchResults.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <p>No matching candidates found for the given requirements.</p>
                        </div>
                    `;
                    matchResults.style.display = 'block';
                    return;
                }

                // Debug: log raw incoming percentages and detect source (AI vs Basic)
                try {
                    console.debug('[MatchResults] Received matches:', matches);
                } catch (e) { /* no-op */ }

                matchResults.innerHTML = allMatches.map(match => {
                    const cv = match.cv || match; // prefer enriched cv
                    // Coerce to a clean numeric percentage without normalizing
                    let percentage = typeof match.percentage === 'string' ? parseFloat(match.percentage) : match.percentage;
                    if (!Number.isFinite(percentage)) { percentage = 0; }
                    const percentageClass = percentage >= 85 ? 'high' : (percentage >= 70 ? 'medium' : 'low');
                    const icon = percentage >= 85 ? 'üèÜ' : (percentage >= 70 ? 'üéØ' : '‚≠ê');
                    const method = match.method || 'unknown';
                    const sourceLabel = method === 'embeddings_cosine'
                        ? 'Embeddings'
                        : method === 'hybrid_embeddings_structured'
                        ? 'Hybrid'
                        : (method.startsWith('ai_') ? 'AI' : method);

                    return `
                        <div class="match-item">
                            <div class="match-header">
                                <div class="match-name">${cv.name || match.name || 'Name not available'}</div>
                                <div class="match-percentage ${percentageClass}">
                                    ${icon} ${percentage}% <span style="font-size: 0.8em; opacity: 0.8;">(${sourceLabel})</span>
                                </div>
                            </div>
                            
                            <div class="match-basic-info">
                                <div class="basic-info-item">
                                    <strong>Specialty:</strong> ${cv.professional_specialty || 'Not specified'}
                                </div>
                                <div class="basic-info-item">
                                    <strong>Experience:</strong> ${cv.total_years_experience || cv.primary_experience_years || 0} years
                                </div>
                            </div>
                            <div class="match-reasoning">
                                <strong>AI Analysis:</strong> ${match.reasoning || 'Match based on profile analysis'}
                                ${cv.summary ? `
                                    <div class="candidate-description">
                                        <strong>Candidate Profile:</strong> ${cv.summary}
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${Array.isArray(match.matchedSkills) && match.matchedSkills.length ? `
                                <div class="matched-skills">
                                    <strong>Matched skills:</strong>
                                    <div class="chips">
                                        ${match.matchedSkills.slice(0, 12).map(s => `<span class='chip'>${s}</span>`).join(' ')}
                                    </div>
                                </div>
                            ` : ''}

                            ${Array.isArray(match.risks || (match.ai && match.ai.risks)) && (match.risks || (match.ai && match.ai.risks)).length ? `
                                <div class="ai-risks">
                                    <strong>Risks / Gaps:</strong>
                                    <ul>
                                        ${(match.risks || (match.ai && match.ai.risks)).slice(0, 5).map(r => `<li>${r}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <div class="match-actions">
                                <button class="contact-info-btn" onclick="app.showContactDetails(${cv.id})">
                                    üìû View Contact Info
                                </button>
                                <button class="full-profile-btn" onclick="app.showFullProfile(${cv.id})">
                                    üë§ Full Profile
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
// {{ ... }}
                matchResults.style.display = 'block';
                
                // Update status to show currently shown qualified info
                const totalCandidates = allMatches.length;
                const statusElement = document.getElementById('matchStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="status success">
                            ‚úÖ Showing ${totalCandidates} candidates
                        </div>
                    `;
                }
            }

            initializeEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const parseBtn = document.getElementById('parseBtn');
                const exportAllBtn = document.getElementById('exportAllBtn');

                // Upload area events
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));

                // File input change
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                // Button events
                parseBtn.addEventListener('click', this.parseFiles.bind(this));
                if (exportAllBtn) {
                    exportAllBtn.addEventListener('click', () => this.exportAllToExcel());
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                this.addFiles(files);
            }

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.addFiles(files);
            }

            addFiles(newFiles) {
                const validFiles = newFiles.filter(file => {
                    const extension = file.name.toLowerCase();
                    return extension.endsWith('.pdf') || extension.endsWith('.docx') || extension.endsWith('.txt');
                });

                if (validFiles.length !== newFiles.length) {
                    this.showStatus('parseStatus', '‚ö†Ô∏è Some files were skipped. Only PDF, DOCX, and TXT files are supported.', 'warning');
                }

                this.files = [...this.files, ...validFiles];
                this.renderFileList();
                this.updateParseButton();
            }

            removeFile(index) {
                this.files.splice(index, 1);
                this.renderFileList();
                this.updateParseButton();
            }

            renderFileList() {
                const fileList = document.getElementById('fileList');
                
                if (this.files.length === 0) {
                    fileList.innerHTML = '';
                    return;
                }

                fileList.innerHTML = this.files.map((file, index) => `
                    <div class="file-item">
                        <span class="file-name">üìÑ ${file.name}</span>
                        <span class="file-size">${this.formatFileSize(file.size)}</span>
                        <button class="remove-file" onclick="app.removeFile(${index})">Remove</button>
                    </div>
                `).join('');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            updateParseButton() {
                const parseBtn = document.getElementById('parseBtn');
                const hasFiles = this.files.length > 0;
                parseBtn.disabled = !hasFiles;
                
                if (hasFiles) {
                    document.getElementById('parseButtonText').textContent = `Parse ${this.files.length} CV${this.files.length > 1 ? 's' : ''} with AI`;
                } else {
                    document.getElementById('parseButtonText').textContent = 'Parse CVs with AI';
                }
            }

            async parseFiles() {
                if (this.files.length === 0) {
                    this.showStatus('parseStatus', '‚ö†Ô∏è Please select files to parse', 'warning');
                    return;
                }

                this.showProgress();
                this.setButtonLoading('parseBtn', 'parseButtonText', 'Parsing CVs with AI...');

                try {
                    const formData = new FormData();
                    this.files.forEach(file => {
                        formData.append('files', file);
                    });

                    // Simulate progress
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 90) progress = 90;
                        this.updateProgress(progress);
                    }, 500);

                    const response = await fetch(`${API_BASE_URL}/parse-cvs`, {
                        method: 'POST',
                        body: formData
                    });

                    clearInterval(progressInterval);
                    this.updateProgress(100);

                    const data = await response.json();

                    if (data.success) {
                        this.showStatus('parseStatus', `‚úÖ ${data.message || 'Successfully parsed CVs'}`, 'success');
                        this.showParsedDataPreview(data.data);
                        this.createConfetti();
                        this.playSuccessSound();
                        
                        // Surface any server-side warnings (e.g., scanned PDFs with no text)
                        if (data.warnings && Array.isArray(data.warnings) && data.warnings.length > 0) {
                            const warningMsg = `‚ö†Ô∏è ${data.warnings.length} issue${data.warnings.length > 1 ? 's' : ''} encountered:\n- ` + data.warnings.join('\n- ');
                            this.showStatus('parseStatus', warningMsg, 'warning');
                        }
                        
                        // Clear uploaded files
                        this.files = [];
                        document.getElementById('fileInput').value = '';
                        this.renderFileList();
                        this.updateParseButton();
                        
                        // Refresh database stats
                        setTimeout(() => this.loadDatabaseStats(), 1000);
                    } else {
                        throw new Error(data.error || 'Parsing failed');
                    }

                } catch (error) {
                    console.error('Parsing error:', error);
                    this.showStatus('parseStatus', `‚ùå Error: ${error.message}`, 'error');
                } finally {
                    this.hideProgress();
                    this.setButtonNormal('parseBtn', 'parseButtonText', 'Parse CVs with AI');
                }
            }

            showParsedDataPreview(parsedData) {
                const preview = document.getElementById('parsedDataPreview');
                const jsonPreview = document.getElementById('jsonPreview');
                
                if (parsedData && parsedData.length > 0) {
                    const summary = parsedData.map(cv => ({
                        name: cv.name || 'Unknown',
                        specialty: cv.professional_specialty || 'Unknown',
                        experience: cv.total_years_experience || 0,
                        email: cv.email || 'Not provided'
                    }));
                    
                    jsonPreview.textContent = JSON.stringify(summary, null, 2);
                    preview.style.display = 'block';
                    
                    // Auto-hide after 10 seconds
                    setTimeout(() => {
                        preview.style.display = 'none';
                    }, 10000);
                }
            }

            convertToExcelData(cvs) {
                return cvs.map((cv, idx) => {
                    // Ensure social links are filled even if only clickable in files
                    this.fillSocialLinksFromMetadata(cv);

                    const skills = cv.skills || {};
                    const experience = cv.experience || [];
                    const education = cv.education || [];
                    const projects = cv.projects || [];
                    const awards = cv.awards || [];
                    const volunteerWork = cv.volunteer_work || [];
                    const coursesCompleted = cv.courses_completed || [];

                    const companies = experience.map(exp => exp.company || 'Unknown');
                    const uniqueCompanies = [...new Set(companies.filter(company => company !== 'Unknown'))];
                    const positions = experience.map(exp => exp.position || 'Unknown');

                    // Format secondary experience fields - exclude if empty or contains education-related terms
                    const secondaryFields = cv.secondary_experience_fields || {};
                    const filteredSecondaryFields = Object.entries(secondaryFields)
                        .filter(([field, years]) => {
                            // Filter out education-related fields and ensure meaningful experience
                            const fieldLower = field.toLowerCase();
                            const isEducationRelated = fieldLower.includes('education') || 
                                                     fieldLower.includes('student') || 
                                                     fieldLower.includes('academic') ||
                                                     fieldLower.includes('university') ||
                                                     fieldLower.includes('school');
                            return !isEducationRelated && years > 0;
                        });
                    const secondaryFieldsText = filteredSecondaryFields.length > 0 
                        ? filteredSecondaryFields.map(([field, years]) => `${field}: ${years} years`).join('; ')
                        : '';

                    // Compose the row; put id at the BEGINNING
                    const row = {
                        id: idx + 1,
                        // Basic Info
                        filename: cv.filename || 'Unknown',
                        name: cv.name || 'N/A',
                        email: cv.email || 'N/A',
                        phone: cv.phone || 'N/A',
                        address: cv.address || 'N/A',
                        linkedin: this.formatLinkForExcel(cv.linkedin),
                        github: this.formatLinkForExcel(cv.github),
                        // Aggregate all project/personal websites
                        website: (() => {
                            const sites = this.collectWebsites(cv);
                            return sites.length ? sites.join(', ') : 'N/A';
                        })(),
                        
                        // Professional Info - ENHANCED
                        professional_specialty: cv.professional_specialty || 'N/A',
                        primary_experience_years: cv.primary_experience_years || 0,
                        secondary_experience_fields: secondaryFieldsText || 'N/A',
                        total_years_experience: cv.total_years_experience || 0,
                        summary: cv.summary || 'N/A',
                        
                        // Experience Summary
                        experience_count: experience.length,
                        companies: uniqueCompanies.length > 0 ? uniqueCompanies.join(', ') : 'N/A',
                        latest_position: positions[0] || 'N/A',
                        
                        // Education Summary - ENHANCED
                        education_count: education.length,
                        highest_university_degree: cv.highest_university_degree || 'N/A',
                        university_name: cv.university_name || 'N/A',
                        highest_degree: education[0]?.degree || 'N/A',
                        latest_education: education[0]?.institution || 'N/A',
                        
                        // Courses and Certifications - NEW
                        courses_completed_count: coursesCompleted.length,
                        course_certificates: this.arrayToString(coursesCompleted.map(course => course.name)),
                        course_providers: this.arrayToString(coursesCompleted.map(course => course.provider)),
                        
                        // Language and Translation - NEW
                        // original_language: cv.original_language || 'English',
                        // translation_applied: cv.metadata?.translation_applied || false,
                        
                        // Skills
                        technical_skills: this.arrayToString(skills.technical_skills),
                        programming_languages: this.arrayToString(skills.programming_languages),
                        frameworks_tools: this.arrayToString(skills.frameworks_tools),
                        soft_skills: this.arrayToString(skills.soft_skills),
                        languages: this.arrayToString(skills.languages),
                        certifications: this.arrayToString(skills.certifications),
                        
                        // Projects and Awards
                        projects_count: projects.length,
                        project_names: this.arrayToString(projects.map(proj => proj.name)),
                        project_technologies: this.arrayToString(
                            projects.flatMap(proj => proj.technologies || [])
                                .filter((tech, index, arr) => arr.indexOf(tech) === index) // Remove duplicates
                        ),
                        awards: this.arrayToString(awards),
                        volunteer_work_count: volunteerWork.length,
                        
                        // Database Info
                        created_at: cv.created_at,
                        updated_at: cv.updated_at,
                        
                        // Enhanced Parsing Metadata - NEW
                        parsing_method: cv.metadata?.parsing_method || 'standard',
                        processed_at: cv.metadata?.processed_at || 'N/A',
                        file_path: cv.metadata?.file_path || 'N/A',
                        
                        // Detailed data as JSON strings
                        experience_details: JSON.stringify(experience),
                        education_details: JSON.stringify(education),
                        projects_details: JSON.stringify(projects),
                        volunteer_work_details: JSON.stringify(volunteerWork),
                        courses_completed_details: JSON.stringify(coursesCompleted),
                        secondary_experience_details: JSON.stringify(secondaryFields),
                        metadata_details: JSON.stringify(cv.metadata || {})
                    };

                    // Add very last column: volunteering_experience_formatted
                    const volunteerFormatted = volunteerWork && volunteerWork.length
                        ? volunteerWork.map(v => {
                            const parts = [];
                            if (v.organization) parts.push(`Org: ${v.organization}`);
                            if (v.role) parts.push(`Role: ${v.role}`);
                            if (v.period) parts.push(`Period: ${v.period}`);
                            if (v.description) parts.push(`Desc: ${v.description}`);
                            return parts.join(' | ');
                        }).join('\n')
                        : 'N/A';
                    row.volunteering_experience = volunteerFormatted;
                    return row;
                });
            }

            arrayToString(arr) {
                if (!arr || !Array.isArray(arr)) return 'N/A';
                return arr.filter(item => item && item.trim()).join(', ') || 'N/A';
            }

            formatLinkForExcel(link) {
                if (!link || link.trim() === '' || link === 'N/A') {
                    return 'N/A';
                }
                
                // Check if the link is already a clickable URL (starts with http/https)
                const trimmedLink = link.trim();
                if (trimmedLink.startsWith('http://') || trimmedLink.startsWith('https://')) {
                    return trimmedLink; // Return the full URL as is
                }
                
                // If it's just a username or partial link, return it as is but indicate it might not be a full URL
                return trimmedLink;
            }

            // Create and download Excel for all CVs
            async exportAllToExcel() {
                // Guard: prevent double-triggered exports
                if (this.exporting) {
                    return;
                }
                this.exporting = true;
                this.setButtonLoading('exportAllBtn', 'exportAllButtonText', 'üì¶ Preparing Excel...');
                try {
                    await this.ensureSheetJS();
                    const resp = await fetch(`${API_BASE_URL}/cvs`);
                    const json = await resp.json();
                    const cvs = json && json.success ? json.data : [];

                    // Convert and build worksheet
                    const rows = this.convertToExcelData(cvs);
                    const ws = XLSX.utils.json_to_sheet(rows, { skipHeader: false });

                    // Resize columns, freeze header, add autofilter
                    try {
                        const ref = ws['!ref'];
                        if (ref) {
                            const range = XLSX.utils.decode_range(ref);
                            // Set reasonable column widths
                            const headerCount = range.e.c - range.s.c + 1;
                            ws['!cols'] = Array.from({ length: headerCount }, (_, i) => {
                                // Make first column (ID) narrow
                                if (i === 0) return { wch: 6 };
                                // Wider for summary/details columns near the end
                                return { wch: (i > headerCount - 5 ? 50 : 22) };
                            });
                            // Freeze first row
                            ws['!freeze'] = { rows: 1, columns: 0 };
                            // Autofilter on header row
                            const headerRef = XLSX.utils.encode_range({ s: { r: 0, c: range.s.c }, e: { r: 0, c: range.e.c } });
                            ws['!autofilter'] = { ref: headerRef };
                        }
                    } catch (e) {
                        console.warn('Sheet formatting setup failed:', e);
                    }

                    // Optional second sheet with education periods
                    const eduRows = this.buildEducationPeriodsSheetData(cvs);
                    const wsEdu = XLSX.utils.json_to_sheet(eduRows, { skipHeader: false });

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'CVs');
                    XLSX.utils.book_append_sheet(wb, wsEdu, 'Education Periods');

                    const ts = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
                    const filename = `cv-database-${ts}.xlsx`;
                    XLSX.writeFile(wb, filename);

                    this.showExportResults(cvs);
                    this.showStatus('exportStatus', '‚úÖ Exported to Excel successfully', 'success');
                } catch (e) {
                    console.error('Export error:', e);
                    this.showStatus('exportStatus', `‚ùå Export failed: ${e.message}`, 'error');
                } finally {
                    this.setButtonNormal('exportAllBtn', 'exportAllButtonText', 'üìä Export All to Excel');
                    // Release export lock after a short tick to avoid rapid re-triggers
                    setTimeout(() => { this.exporting = false; }, 300);
                }
            }

            showExportResults(cvs) {
                const results = document.getElementById('results');
                const exportResults = document.getElementById('exportResults');
                
                results.style.display = 'block';
                
                const totalCandidates = cvs.length;
                const avgExperience = cvs.reduce((sum, cv) => sum + (cv.total_years_experience || 0), 0) / totalCandidates;
                const specialties = {};
                
                cvs.forEach(cv => {
                    const specialty = cv.professional_specialty || 'Unknown';
                    specialties[specialty] = (specialties[specialty] || 0) + 1;
                });

                const topSpecialties = Object.entries(specialties)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([specialty, count]) => `${specialty} (${count})`)
                    .join(', ');

                exportResults.innerHTML = `
                    <div class="result-item">
                        <strong>üìä Total Candidates:</strong> ${totalCandidates}
                    </div>
                    <div class="result-item">
                        <strong>üìà Average Experience:</strong> ${avgExperience.toFixed(1)} years
                    </div>
                    <div class="result-item">
                        <strong>üéØ Top Specialties:</strong> ${topSpecialties || 'Various'}
                    </div>
                    <div class="result-item">
                        <strong>üìã Export Format:</strong> Excel (.xlsx) with complete database
                    </div>
                `;
                
                // Auto-hide after 15 seconds
                setTimeout(() => {
                    results.style.display = 'none';
                }, 15000);
            }

            // Utility methods
            showProgress() {
                document.getElementById('progressBar').style.display = 'block';
            }

            hideProgress() {
                document.getElementById('progressBar').style.display = 'none';
            }

            updateProgress(percentage) {
                document.getElementById('progressFill').style.width = percentage + '%';
            }

            setButtonLoading(btnId, textId, loadingText) {
                const btn = document.getElementById(btnId);
                const text = document.getElementById(textId);
                btn.disabled = true;
                text.innerHTML = `<span class="loading"></span>${loadingText}`;
            }

            setButtonNormal(btnId, textId, normalText) {
                const btn = document.getElementById(btnId);
                const text = document.getElementById(textId);
                btn.disabled = false;
                text.textContent = normalText;
            }

            showStatus(statusId, message, type) {
                const status = document.getElementById(statusId);
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => this.hideStatus(statusId), 8000);
                } else if (type === 'warning') {
                    setTimeout(() => this.hideStatus(statusId), 5000);
                }
            }

            hideStatus(statusId) {
                const status = document.getElementById(statusId);
                status.style.display = 'none';
            }

            // Success effects
            playSuccessSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    // Audio not supported, continue silently
                }
            }

            createConfetti() {
                const colors = ['#4facfe', '#00f2fe', '#f093fb', '#f5576c', '#fff'];
                
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.style.cssText = `
                            position: fixed;
                            width: 8px;
                            height: 8px;
                            background: ${colors[Math.floor(Math.random() * colors.length)]};
                            top: -10px;
                            left: ${Math.random() * window.innerWidth}px;
                            z-index: 10000;
                            pointer-events: none;
                            border-radius: 50%;
                        `;
                        
                        document.body.appendChild(confetti);
                        
                        const animation = confetti.animate([
                            { 
                                transform: 'translateY(0px) rotateZ(0deg)', 
                                opacity: 1 
                            },
                            { 
                                transform: `translateY(${window.innerHeight + 100}px) rotateZ(720deg)`, 
                                opacity: 0 
                            }
                        ], {
                            duration: 3000 + Math.random() * 2000,
                            easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                        });
                        
                        animation.onfinish = () => {
                            if (confetti.parentNode) {
                                confetti.parentNode.removeChild(confetti);
                            }
                        };
                    }, i * 50);
                }
            }
        }

        // Initialize the application
        const app = new CVParserApp();

        // Enhanced UI interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'u':
                            e.preventDefault();
                            document.getElementById('fileInput').click();
                            break;
                        case 'Enter':
                            e.preventDefault();
                            if (!document.getElementById('parseBtn').disabled) {
                                app.parseFiles();
                            }
                            break;
                        case 'e':
                            e.preventDefault();
                            if (!app.exporting) {
                                app.exportAllToExcel();
                            }
                            break;
                        case 'r':
                            e.preventDefault();
                            app.loadDatabaseStats();
                            break;
                        case 'm':
                            e.preventDefault();
                            app.findMatches();
                            break;
                    }
                }
            });

            // Enhanced drag and drop feedback
            let dragCounter = 0;
            document.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dragCounter++;
                if (dragCounter === 1) {
                    document.body.style.background = 'linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)';
                }
            });

            document.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    document.body.style.background = '';
                }
            });

            document.addEventListener('drop', function(e) {
                e.preventDefault();
                dragCounter = 0;
                document.body.style.background = '';
            });

            // Auto-refresh database stats every 30 seconds
            setInterval(() => {
                app.checkConnection();
            }, 30000);

            // Add smooth scrolling for better UX
            document.documentElement.style.scrollBehavior = 'smooth';

            // Initialize tooltips for keyboard shortcuts
            const shortcuts = [
                { element: 'parseBtn', shortcut: 'Ctrl+Enter' },
                { element: 'exportAllBtn', shortcut: 'Ctrl+E' },
                { element: 'refreshBtn', shortcut: 'Ctrl+R' },
                { element: 'matchBtn', shortcut: 'Ctrl+M' },
                { element: 'uploadArea', shortcut: 'Ctrl+U' }
            ];

            shortcuts.forEach(({ element, shortcut }) => {
                const el = document.getElementById(element);
                if (el) {
                    el.title = `${el.title || ''} (${shortcut})`.trim();
                }
            });

            // Add real-time character count for requirements input
            const requirementsInput = document.getElementById('requirementsInput');
            const createCharCounter = () => {
                const counter = document.createElement('div');
                counter.style.cssText = `
                    position: absolute;
                    bottom: 0.5rem;
                    right: 1rem;
                    font-size: 0.8rem;
                    opacity: 0.6;
                    background: rgba(0,0,0,0.5);
                    padding: 0.25rem 0.5rem;
                    border-radius: 4px;
                `;
                requirementsInput.parentNode.style.position = 'relative';
                requirementsInput.parentNode.appendChild(counter);
                return counter;
            };

            const charCounter = createCharCounter();
            requirementsInput.addEventListener('input', () => {
                const length = requirementsInput.value.length;
                charCounter.textContent = `${length} characters`;
                charCounter.style.color = length > 500 ? '#f59e0b' : '#9ca3af';
            });

            console.log('üöÄ CV Parser Pro initialized successfully!');
            console.log('üìã Features: Backend API integration, Persistent database, Real-time stats, AI matching');
            console.log('‚å®Ô∏è  Keyboard shortcuts: Ctrl+U (upload), Ctrl+Enter (parse), Ctrl+E (export), Ctrl+R (refresh), Ctrl+M (match)');
            console.log('üé® Enhanced UI with better visual hierarchy and responsive design');
        });

        // Add some nice hover effects and interactions
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('stat-card')) {
                e.target.style.transform = 'translateY(-3px) scale(1.02)';
            }
        });

        document.addEventListener('mouseout', function(e) {
            if (e.target.classList.contains('stat-card')) {
                e.target.style.transform = '';
            }
        });

        // Error handling for network issues
        window.addEventListener('offline', function() {
            document.getElementById('connectionStatus').textContent = 'üì° Offline Mode';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });

        window.addEventListener('online', function() {
            app.checkConnection();
        });

        // Prevent accidental page refresh when there are unsaved files
        window.addEventListener('beforeunload', function(e) {
            if (app.files && app.files.length > 0) {
                e.preventDefault();
                e.returnValue = 'You have uploaded files that haven\'t been parsed yet. Are you sure you want to leave?';
            }
        });
    </script>
</body>
</html>
                        